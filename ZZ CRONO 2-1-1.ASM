LIST P= 16F887
INCLUDE <P16F887.INC>

; CONFIG1
; __config 0xFFE1
 __CONFIG _CONFIG1, _FOSC_XT & _WDTE_OFF & _PWRTE_ON & _MCLRE_OFF & _CP_OFF & _CPD_OFF & _BOREN_ON & _IESO_ON & _FCMEN_OFF & _LVP_OFF
; CONFIG2
; __config 0xFFFF
 __CONFIG _CONFIG2, _BOR4V_BOR40V & _WRT_OFF


DIG1	equ	20h
DIG2	equ	21h
DIG3	equ	22h
DIG4	equ	23h
CIEN	EQU	24H
DIEZ	EQU	25H
ROTA	EQU	26H
RECIB	EQU	27H
TRANS	EQU	28H
ANDA	EQU	29H

ORG		0X00
GOTO	START

ORG		0X04
GOTO	RSI

ORG		0X05


START	CLRF	STATUS
		BCF		STATUS,Z
		BSF		STATUS,RP0
		MOVLW	B'00000000'
		MOVWF	TRISD
		MOVLW	B'11110000'
		MOVWF	TRISA
		MOVLW	B'00000111'		;<------------------- PRESCALER
		MOVWF	OPTION_REG
		MOVLW	B'11011000'
		MOVWF	INTCON			;T0IF=1 PEIE=1
		BSF		PIE1,RCIE		;Habilitadas interrup. por PEIE, TMR0, INTE
		BSF		STATUS,RP0
		BSF		STATUS,RP1
		MOVLW	B'00000000'
		MOVWF	ANSELH
		BCF		STATUS,RP1
		MOVLW	B'11111111'
		MOVWF	TRISB
		MOVLW	B'11111111'
		MOVWF	WPUB
		
		

		;CONFIGURACION UART
		;-------------------------------------------------------
		;REGISTRO TXSTA
		BSF		STATUS,RP0
		BCF		STATUS,RP1
		MOVLW	B'00100100'
		MOVWF	TXSTA		;BRGH=1 PARA CRISTAL DE 4 MHZ
		;CONFIG DE BAUDRATE A 9600
		MOVLW	D'25'
		MOVWF	SPBRG
		;CONFIG DEL REGISTRO RCSTA	(RECEIVE STATUS & CONTROL REG)
		BCF		STATUS,RP0  
		MOVLW	B'10010000'
		MOVWF	RCSTA
		
		;CONFIGURACION PARA EL REGISTRO BAUDCTL 
		BSF 	STATUS,RP0
		BSF		STATUS,RP1
		MOVLW	B'01000000'
		MOVWF	BAUDCTL
		BCF		STATUS,RP1
		BCF		STATUS,RP0
	
		;NUMEROS FICTICIOS
		MOVLW	D'0'
		MOVWF	DIG1
		MOVLW	D'0'
		MOVWF	DIG2
		MOVLW	D'0'
		MOVWF	DIG3
		MOVLW	D'0'
		MOVWF	DIG4
		MOVLW	D'216'
		MOVWF	TMR0

EMPE	MOVLW	B'00001000'
		MOVWF	ROTA
		CLRF	PORTA
		MOVLW	DIG1
		MOVWF	FSR
DISP	CLRF	PORTD
		MOVF	ROTA,W
		MOVWF	PORTA

		MOVF	INDF,0
		CALL	TABLA
		MOVWF	PORTD
		CALL	RETARDO
		CLRF	PORTD
		BTFSC	ROTA,0
		GOTO	EMPE
		BCF		STATUS,C
		RRF		ROTA,1
		INCF	FSR,1
		GOTO	DISP


TABLA	ADDWF	PCL,1
;		ORDEN DE LOS SEGMENTOS .GFEDCBA
;		ORDEN DE
		RETLW	B'00111111' ;0
		RETLW	B'00000110'	;1
		RETLW	B'01011011'	;2
		RETLW	B'01001111'	;3
		RETLW	B'01100110'	;4
		RETLW	B'01101101'	;5
		RETLW	B'01111101'	;6
		RETLW	B'00000111'	;7
		RETLW	B'01111111'	;8
		RETLW	B'01101111'	;9

RSI		BTFSC	INTCON,INTF
		GOTO	BOTONSS

		BTFSC	INTCON,T0IF
		GOTO	CENT
		
		BTFSS	PIR1,RCIF
		RETFIE
		CALL	RECIBE

BOTONSS	CALL	RETAR2
		BTFSS	INTCON,T0IE     ;TMR0 CORRIENDO?
		GOTO	PARADO			;NO
		GOTO	PREND			;SI

PARADO	BCF		INTCON,INTF
		CLRF	DIG1
		CLRF	DIG2
		CLRF	DIG3
		CLRF	DIG4
		BSF		INTCON,T0IE		;HABILITA INTERRUP POR TMR0 (PARA EL CRONOMETRO)
		RETFIE

PREND	BCF		INTCON,INTF
		BCF		INTCON,T0IE
		RETFIE

RECIBE	BCF		PIR1,RCIF
		MOVF	RCREG,W
		MOVWF	DIG2
		RETFIE

CENT	MOVLW	D'216'
		MOVWF	TMR0
		BCF		INTCON,T0IF
		INCF	DIG4,F
		MOVLW	D'10'
		SUBWF	DIG4,W
		BTFSS	STATUS,Z
		RETFIE
		
DECIMA	CLRF	DIG4
		INCF	DIG3
		MOVLW	D'10'
		SUBWF	DIG3,W
		BTFSS	STATUS,Z
		RETFIE
		
SEGUNDO	CLRF	DIG3
		INCF	DIG2
		MOVLW	D'10'
		SUBWF	DIG2,W
		BTFSS	STATUS,Z
		RETFIE

DISEG	CLRF	DIG2
		INCF	DIG1
		MOVLW	D'10'
		SUBWF	DIG1,W
		BTFSS	STATUS,Z
		RETFIE
		CLRF	DIG1
		RETFIE

RETARDO	MOVLW	D'8'
		MOVWF	CIEN
		MOVLW	D'2'
		MOVWF	DIEZ
L1		NOP
		NOP
		NOP
		DECFSZ	CIEN
		GOTO	L1
		DECFSZ	DIEZ
		GOTO	L1
		RETURN

RETAR2	MOVLW	D'10'  ;RETARDO DE 1ms
		MOVWF	CIEN
		MOVLW	D'20'
		MOVWF	DIEZ
L2		NOP
		NOP
		NOP
		NOP
		NOP
		DECFSZ	DIEZ
		GOTO	L2
		DECFSZ	CIEN
		GOTO	L2
		RETURN

		END